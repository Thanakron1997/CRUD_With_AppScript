<script>
window.addEventListener("load", functionInit, true); 
  function functionInit(){  
    preventFormSubmit();
    getLastTenRows();
  };

  function preventFormSubmit() {
    var forms = document.querySelectorAll('form');
    for (var i = 0; i < forms.length; i++) {
      forms[i].addEventListener('submit', function(event) {
      event.preventDefault();
      });
    }
  }

    function handleFormSubmit(formObject) {
    google.script.run.withSuccessHandler(createTable).processForm(formObject);
    setTimeout(function() {$('#myModal').modal('hide');}, 3000);
    document.getElementById("message").innerHTML = "<div class='alert alert-warning' role='alert'>SAVED!.</div>";
    document.getElementById("myForm").reset();
  }

  function clearForm() {
    document.getElementById("message").innerHTML = "";
    document.getElementById("myForm").reset();
  }

  function getLastTenRows (){
   google.script.run.withSuccessHandler(createTable).getLastTenRows();
  }
  
  function getAllData(){
    google.script.run.withSuccessHandler(createTable).getAllData();
  }

  function createTable(dataArray) {
    if(dataArray){
      var result = "<div>"+
                   "<table class='table table-sm' style='font-size:1em'>"+
                   "<thead style='white-space: nowrap'>"+
                     "<tr>"+
                      "<th scope='col'>Delete</th>"+
                      "<th scope='col'>Edit</th>"+
                      "<th scope='col'>ID</th>"+
                      "<th scope='col'>Subject Number</th>"+
                      "<th scope='col'>Name</th>"+
                      "<th scope='col'>Last Name</th>"+
                      "<th scope='col'>Gender</th>"+
                      "<th scope='col'>Hospital Number</th>"+
                      "<th scope='col'>phone Number</th>"+
                      "<th scope='col'>Date of Brith</th>"+
                      "<th scope='col'>Address</th>"+
                      "<th scope='col'>Parent Name</th>"+
                    "</tr>"+
                  "</thead>";
      for(var i=0; i<dataArray.length; i++) {
          result += "<tr>";

          result += "<td><button type='button' class='btn btn-outline-danger btn-xs deleteBtn' onclick='deleteData(this);'><i class='fa fa-trash''></i></button></td>";
       
          result += "<td><button type='button' class='btn btn-outline-primary btn-xs editBtn' data-toggle='modal' data-target='#myModal' onclick='editData(this);'><i class='fa fa-edit'></i></button></td>";
 
  
       for(var j=0; j<dataArray[i].length; j++){
              result += "<td>"+dataArray[i][j]+"</td>";
          }
          result += "</tr>";
      }
      result += "</table></div>";
      var div = document.getElementById('dataTable');
      div.innerHTML = result;
       $(document).ready(function() {
       $('#dataTable').DataTable({
         destroy:true,
         responsive: true,
         ordering: false,
         searching:false,
         pageLength: 5, 
         lengthMenu: [
          [5, 10, 25, 50, 100, -1 ],
          ['5', '10', '25', '50','100', 'All' ]
      ],
               columnDefs: [
            {
             // targets: "_all",              
              },
            ],
            //ภาษาไทย
      language: {
      sProcessing: "Processing...",
      sLengthMenu: "_MENU_ ",
      sZeroRecords: "No Data",
      sInfo: 'Showing _START_ to _END_ of _TOTAL_ entries',
      // sInfoEmpty: "แสดง 0 ถึง 0 จาก 0 แถว",
      // sInfoFiltered: "(กรองข้อมูล _MAX_ ทุกแถว)",
      sInfoPostFix: "",
      sSearch: '<i class="fas fa-search" fa-2x></i> ค้นหา:',
      sUrl: "",
      oPaginate: {
        sFirst: "First Page",
        sPrevious: 'Previous',
        sNext: 'Next',
        sLast: "Last Page"
      }, 
    },

          });
        });

      document.getElementById("message").innerHTML = "";
    }else{
      var div = document.getElementById('dataTable');
      div.innerHTML = "False!";
    }
  }

  function deleteData(el) {
    Swal.fire({
  title: 'Do You Want Delete This Data?',
    showCancelButton: true,
    confirmButtonColor: '#3085d6',
    cancelButtonColor: '#d33',
    cancelButtonText: 'Cencel',
    confirmButtonText: 'Confirm'
    }).then((result) => {
      if (result.isConfirmed) {

        Swal.fire(
      'Deleted!',
        )

        var recordId = el.parentNode.parentNode.cells[2].innerHTML;
        google.script.run.withSuccessHandler(createTable).deleteData(recordId);
      }
    });
  }

  function editData(el){
    var recordId = el.parentNode.parentNode.cells[2].innerHTML; 
    google.script.run.withSuccessHandler(populateForm).getRecordById(recordId);
  }

  function populateForm(records){
    document.getElementById('RecId').value = records[0][0];
    document.getElementById('subject').value = records[0][1];
    document.getElementById('name').value = records[0][2];
    document.getElementById('lastname').value = records[0][3];
    document.getElementById('gender').value = records[0][4];
    document.getElementById('hospitalNumber').value = records[0][5];
    document.getElementById('phone').value = records[0][6];
    document.getElementById('dob').value = records[0][7];
    document.getElementById('address').value = records[0][8];
    document.getElementById('parentName').value = records[0][9];
    document.getElementById("message").innerHTML = "<div class='alert alert-warning' role='alert'>Update Record [ID: "+records[0][0]+"]</div>";
  }
  
    function loading(){
      window.addEventListener("load", functionInit, false);
      window.addEventListener("load", preventFormSubmitSearch, true);
}

    function loading(){
      window.addEventListener("load", functionInit, false);
      window.addEventListener("load", preventFormSubmitSearch, true);
    }
          function preventFormSubmitSearch() {
            var forms = document.querySelectorAll('form');
            for (var i = 0; i < forms.length; i++) {
              forms[i].addEventListener('submit', function(event) {
              event.preventDefault();
              });
            }
          }           

          function handleFormSubmitSearch(formObject) {
            google.script.run.withSuccessHandler(createTableSearch).processFormSearch(formObject);
            document.getElementById("search-form").reset();
          }

          function createTableSearch(dataArray) {
            if(dataArray && dataArray !== undefined && dataArray.length != 0){
              var result = "<div>"+
                   "<table class='table table-sm' style='font-size:1em'>"+
                   "<thead style='white-space: nowrap'>"+
                     "<tr>"+
                     //Change table headings to match witht he Google Sheet   
                      "<th scope='col'>Delete</th>"+
                      "<th scope='col'>Edit</th>"+                         
                      "<th scope='col'>ID</th>"+
                      "<th scope='col'>Subject Number</th>"+
                      "<th scope='col'>Name</th>"+
                      "<th scope='col'>Last Name</th>"+
                      "<th scope='col'>Gender</th>"+
                      "<th scope='col'>Hospital Number</th>"+
                      "<th scope='col'>phone Number</th>"+
                      "<th scope='col'>Date of Brith</th>"+
                      "<th scope='col'>Address</th>"+
                      "<th scope='col'>Parent Name</th>"+
                    "</tr>"+
                  "</thead>";
      for(var i=0; i<dataArray.length; i++) {
          result += "<tr>";

          result += "<td><button type='button' class='btn btn-outline-danger btn-xs deleteBtn' onclick='deleteData(this);'><i class='fa fa-trash''></i></button></td>";
          result += "<td><button type='button' class='btn btn-outline-primary btn-xs editBtn' data-toggle='modal' data-target='#myModal' onclick='editData(this);'><i class='fa fa-edit'></i></button></td>";

         for(var j=0; j<dataArray[i].length; j++){
              result += "<td>"+dataArray[i][j]+"</td>";
          }
          result += "</tr>";
      }
      result += "</table></div>";
              //var div = document.getElementById('search-results');
              var div = document.getElementById('dataTable');
              div.innerHTML = result;
            }else{
              //var div = document.getElementById('search-results');
              var div = document.getElementById('dataTable');
              Swal.fire({
              title: 'No Data!',
              showCancelButton: false,
              });
            }
          }

</script>
